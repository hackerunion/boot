#!/bin/bash

# This is run on the server to deploy the dockerized kernel, to synchronize the repositories, and to reload on error
HOST_ROOT="$HOME/root"
BOOT="$HOST_ROOT/boot"
SRC="$HOST_ROOT/usr/src/kernel"

SYNC="$BOOT/bin/opt/git-sync"

if [ ! -x "$SYNC" ]; then
  echo "Unable to find git-sync in boot repository. Exiting..."
  exit 1
fi

sync() {
  pushd "$BOOT"

  if ! $SYNC; then
    echo "Sync failed for boot, aborting."
    return 1
  fi

  git checkout master

  popd

  pushd $SRC

  if ! $SYNC; then
    echo "Sync failed for kernel, aborting."
    return 2
  fi

  git checkout master

  popd

  pushd $HOST_ROOT

  if ! $SYNC; then
    echo "Sync failed for root, aborting."
    return 3
  fi

  git checkout master

  popd
}

echo "Deploy script running on remote server."

if sync; then
  echo "Sync was successful"
else
  echo "Sync failed"
fi
